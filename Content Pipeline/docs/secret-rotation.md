# Secret Rotation & Security Best Practices

This document outlines procedures for rotating API keys, managing secrets, and implementing security best practices for the Content Pipeline system.

## 🔐 Security Overview

The Content Pipeline system handles sensitive credentials and API keys that require regular rotation and secure management. This document provides comprehensive procedures for maintaining security throughout the system lifecycle.

## 🗝️ Secrets Management

### Current Secrets in Supabase Vault

The following secrets are stored in Supabase Vault and require regular rotation:

1. **OpenAI API Key** (`OPENAI_API_KEY`)
   - Used for content generation
   - Rotation frequency: Quarterly or when compromised
   - Format: `sk-...`

2. **WordPress App Password** (`WORDPRESS_APP_PASSWORD`)
   - Used for WordPress authentication
   - Rotation frequency: Quarterly or when compromised
   - Format: Generated by WordPress

3. **WordPress Username** (`WORDPRESS_USERNAME`)
   - WordPress user account for content posting
   - Rotation frequency: As needed
   - Format: Username string

4. **WordPress URL** (`WORDPRESS_URL`)
   - WordPress site endpoint
   - Rotation frequency: When site URL changes
   - Format: `https://example.com`

5. **Configuration Secrets**
   - `DEFAULT_CATEGORY`: Default WordPress category
   - `DEFAULT_TAGS`: Default WordPress tags
   - `CONTENT_TARGET_WORDS`: Target word count for content

## 🔄 Secret Rotation Procedures

### 1. OpenAI API Key Rotation

#### Pre-Rotation Checklist
- [ ] Verify current API key is working
- [ ] Generate new API key in OpenAI dashboard
- [ ] Test new API key with a simple request
- [ ] Schedule rotation during low-traffic period
- [ ] Notify team of maintenance window

#### Rotation Steps

**Step 1: Generate New API Key**
```bash
# Log into OpenAI dashboard
# Navigate to API Keys section
# Generate new API key
# Copy the new key (starts with sk-)
```

**Step 2: Update Supabase Vault**
```bash
# Update the secret in Supabase Vault
supabase secrets set OPENAI_API_KEY=sk-your-new-api-key-here

# Verify the secret was updated
supabase secrets list | grep OPENAI_API_KEY
```

**Step 3: Test New Key**
```bash
# Test the new API key with a simple request
supabase functions invoke openai-failure-test --data '{"test_type": "api_key_validation"}'
```

**Step 4: Monitor System**
```bash
# Check system health after rotation
curl -X GET https://your-project.supabase.co/functions/v1/health

# Monitor for any errors in the next hour
curl -X GET https://your-project.supabase.co/functions/v1/monitoring
```

**Step 5: Revoke Old Key**
```bash
# After confirming new key works, revoke old key in OpenAI dashboard
# This prevents any potential security issues
```

#### Post-Rotation Verification
- [ ] All functions using OpenAI are working
- [ ] No error logs related to authentication
- [ ] Content generation is successful
- [ ] Old API key is revoked
- [ ] Update documentation with rotation date

### 2. WordPress Credentials Rotation

#### Pre-Rotation Checklist
- [ ] Verify current WordPress user has proper permissions
- [ ] Create new app password in WordPress
- [ ] Test new credentials with WordPress REST API
- [ ] Schedule rotation during low-traffic period

#### Rotation Steps

**Step 1: Create New App Password**
```bash
# Log into WordPress admin dashboard
# Navigate to Users > Profile
# Scroll to Application Passwords section
# Create new app password with name "content-pipeline-YYYY-MM"
# Copy the generated password
```

**Step 2: Update Supabase Vault**
```bash
# Update WordPress app password
supabase secrets set WORDPRESS_APP_PASSWORD=your-new-app-password-here

# Verify the secret was updated
supabase secrets list | grep WORDPRESS_APP_PASSWORD
```

**Step 3: Test New Credentials**
```bash
# Test WordPress connectivity with new credentials
supabase functions invoke wordpress-test --data '{"test_type": "authentication"}'
```

**Step 4: Monitor System**
```bash
# Check for any WordPress-related errors
curl -X GET https://your-project.supabase.co/functions/v1/monitoring

# Test content posting
curl -X POST https://your-project.supabase.co/functions/v1/content-automation \
  -H "Authorization: Bearer YOUR_SERVICE_ROLE_KEY" \
  -H "Content-Type: application/json" \
  -d '{"action": "test_wordpress_posting"}'
```

**Step 5: Revoke Old App Password**
```bash
# After confirming new credentials work, revoke old app password in WordPress
# Navigate to Users > Profile > Application Passwords
# Delete the old app password
```

#### Post-Rotation Verification
- [ ] WordPress authentication is working
- [ ] Content posting to WordPress is successful
- [ ] No authentication errors in logs
- [ ] Old app password is revoked
- [ ] Update documentation with rotation date

### 3. Emergency Secret Rotation

In case of suspected compromise or security breach:

#### Immediate Actions
1. **Rotate All Secrets Immediately**
   ```bash
   # Rotate OpenAI API key
   supabase secrets set OPENAI_API_KEY=new-emergency-key
   
   # Rotate WordPress credentials
   supabase secrets set WORDPRESS_APP_PASSWORD=new-emergency-password
   ```

2. **Revoke Compromised Keys**
   - Immediately revoke old keys in respective dashboards
   - Monitor for any unauthorized usage

3. **Audit System Access**
   ```sql
   -- Check for any suspicious admin actions
   SELECT * FROM admin_retry_audit_log 
   WHERE created_at >= NOW() - INTERVAL '24 hours'
   ORDER BY created_at DESC;
   ```

4. **Notify Security Team**
   - Document the incident
   - Notify relevant stakeholders
   - Update security procedures if needed

## 🛡️ Security Best Practices

### 1. Secret Storage

**Supabase Vault Best Practices:**
- Never store secrets in code or configuration files
- Use Supabase Vault for all sensitive data
- Regularly audit stored secrets
- Implement least privilege access

**Secret Naming Conventions:**
```
OPENAI_API_KEY
WORDPRESS_APP_PASSWORD
WORDPRESS_USERNAME
WORDPRESS_URL
DEFAULT_CATEGORY
DEFAULT_TAGS
CONTENT_TARGET_WORDS
```

### 2. Access Control

**Service Role Authentication:**
- Use service role keys only for admin operations
- Implement proper authentication for all admin functions
- Log all admin actions for audit purposes

**User Permissions:**
- WordPress user should have minimal required permissions
- Only allow content creation and editing
- Restrict access to sensitive WordPress areas

### 3. Network Security

**API Security:**
- Use HTTPS for all external API calls
- Implement proper CORS policies
- Validate all incoming requests
- Rate limit external API calls

**Database Security:**
- Use connection pooling
- Implement proper SQL injection prevention
- Regular security updates
- Monitor database access logs

### 4. Monitoring & Alerting

**Security Monitoring:**
```sql
-- Monitor for suspicious admin actions
SELECT admin_user, action, created_at, ip_address
FROM admin_retry_audit_log
WHERE created_at >= NOW() - INTERVAL '24 hours'
ORDER BY created_at DESC;

-- Check for failed authentication attempts
SELECT job_id, last_error, retry_count
FROM content_jobs
WHERE last_error LIKE '%authentication%'
AND created_at >= NOW() - INTERVAL '24 hours';
```

**Alert Thresholds:**
- Multiple failed authentication attempts
- Unusual admin activity patterns
- High error rates from external APIs
- Unauthorized access attempts

### 5. Data Protection

**Content Security:**
- Validate all generated content before posting
- Implement content filtering for sensitive topics
- Regular content audits
- Secure content storage and transmission

**Log Security:**
- Sanitize logs to remove sensitive information
- Implement log rotation and archival
- Secure log storage and access
- Regular log analysis for security issues

## 📋 Security Checklist

### Daily Security Tasks
- [ ] Review error logs for security issues
- [ ] Check for failed authentication attempts
- [ ] Monitor admin action logs
- [ ] Verify system health and performance

### Weekly Security Tasks
- [ ] Review access logs and patterns
- [ ] Check for unusual activity
- [ ] Verify all secrets are properly stored
- [ ] Update security documentation if needed

### Monthly Security Tasks
- [ ] Plan secret rotation schedule
- [ ] Review and update access permissions
- [ ] Conduct security audit
- [ ] Update security procedures
- [ ] Review and test incident response procedures

### Quarterly Security Tasks
- [ ] Rotate all API keys and passwords
- [ ] Conduct comprehensive security review
- [ ] Update security policies and procedures
- [ ] Review and update monitoring and alerting
- [ ] Conduct security training for team members

## 🚨 Incident Response

### Security Incident Classification

**Level 1 - Low Risk:**
- Single failed authentication attempt
- Minor configuration issues
- Non-critical system errors

**Level 2 - Medium Risk:**
- Multiple failed authentication attempts
- Unusual access patterns
- API key exposure in logs

**Level 3 - High Risk:**
- Suspected API key compromise
- Unauthorized system access
- Data breach or exposure

### Incident Response Procedures

**Immediate Response (0-15 minutes):**
1. Assess the severity of the incident
2. Isolate affected systems if necessary
3. Document the incident details
4. Notify security team

**Short-term Response (15-60 minutes):**
1. Rotate compromised secrets
2. Review access logs
3. Implement additional monitoring
4. Notify stakeholders

**Long-term Response (1-24 hours):**
1. Conduct thorough investigation
2. Update security procedures
3. Implement additional safeguards
4. Document lessons learned

## 📊 Security Metrics

### Key Security Indicators

1. **Authentication Success Rate**: Should be >95%
2. **Failed Login Attempts**: Monitor for spikes
3. **Admin Action Frequency**: Track unusual patterns
4. **API Key Usage**: Monitor for anomalies
5. **Error Rate by Type**: Identify security-related errors

### Security Reporting

**Daily Security Report:**
```sql
SELECT 
  DATE(created_at) as date,
  COUNT(*) FILTER (WHERE last_error LIKE '%auth%') as auth_errors,
  COUNT(*) FILTER (WHERE last_error LIKE '%permission%') as permission_errors,
  COUNT(*) as total_errors
FROM content_jobs
WHERE created_at >= NOW() - INTERVAL '7 days'
GROUP BY DATE(created_at)
ORDER BY date DESC;
```

**Weekly Security Summary:**
- Total security incidents
- Failed authentication attempts
- Admin actions performed
- Secret rotation status
- System vulnerabilities identified

## 🔧 Security Tools & Commands

### Secret Management Commands

```bash
# List all secrets
supabase secrets list

# Set a new secret
supabase secrets set SECRET_NAME=secret_value

# Remove a secret
supabase secrets unset SECRET_NAME

# Test secret functionality
supabase functions invoke function-name --data '{"test": "secret"}'
```

### Security Monitoring Commands

```bash
# Check system health
curl -X GET https://your-project.supabase.co/functions/v1/health

# Review monitoring data
curl -X GET https://your-project.supabase.co/functions/v1/monitoring

# Check metrics
curl -X GET https://your-project.supabase.co/functions/v1/metrics
```

### Database Security Queries

```sql
-- Check for suspicious admin actions
SELECT * FROM admin_retry_audit_log 
WHERE created_at >= NOW() - INTERVAL '24 hours'
ORDER BY created_at DESC;

-- Review authentication errors
SELECT job_id, last_error, retry_count, created_at
FROM content_jobs
WHERE last_error LIKE '%auth%'
ORDER BY created_at DESC;

-- Check system performance
SELECT status, COUNT(*) as count
FROM content_jobs
WHERE created_at >= NOW() - INTERVAL '24 hours'
GROUP BY status;
```

## 📚 Security Resources

### Documentation References
- [Supabase Security Documentation](https://supabase.com/docs/guides/platform/security)
- [OpenAI API Security](https://platform.openai.com/docs/guides/safety-best-practices)
- [WordPress Security Best Practices](https://wordpress.org/support/article/hardening-wordpress/)

### Security Contacts
- **Security Team**: [Contact Information]
- **System Administrator**: [Contact Information]
- **Technical Lead**: [Contact Information]

### Emergency Contacts
- **24/7 Security Hotline**: [Phone Number]
- **Incident Response Team**: [Contact Information]
- **Vendor Security Support**: [Contact Information]

---

**Last Updated:** [Current Date]
**Version:** 1.0
**Next Review:** [Next Review Date]
**Approved By:** [Security Team Lead]
