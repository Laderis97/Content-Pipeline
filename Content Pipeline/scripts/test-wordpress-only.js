#!/usr/bin/env node

/**
 * WordPress-Only Publishing Test
 * Tests WordPress publishing without OpenAI (using mock content)
 */

const https = require('https');

// Configuration
const CONFIG = {
  supabase: {
    url: 'https://zjqsfdqhhvhbwqmgdfzn.supabase.co',
    anonKey: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpqcXNmZHFoaHZoYndxbWdkZnpuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcwNDY1ODMsImV4cCI6MjA3MjYyMjU4M30.P8mYi9WaOV4HkxdJsbOU_nYo1_bbJkI_1LNlbhT4Ifo'
  }
};

// Colors for console output
const colors = {
  green: '\x1b[32m',
  red: '\x1b[31m',
  yellow: '\x1b[33m',
  blue: '\x1b[34m',
  cyan: '\x1b[36m',
  magenta: '\x1b[35m',
  reset: '\x1b[0m',
  bold: '\x1b[1m'
};

function log(message, color = 'reset') {
  console.log(`${colors[color]}${message}${colors.reset}`);
}

function makeRequest(url, options = {}) {
  return new Promise((resolve, reject) => {
    const urlObj = new URL(url);
    const requestOptions = {
      hostname: urlObj.hostname,
      port: urlObj.port || 443,
      path: urlObj.pathname + urlObj.search,
      method: options.method || 'GET',
      headers: {
        'Content-Type': 'application/json',
        'User-Agent': 'Content-Pipeline-Test/1.0',
        ...options.headers
      },
      timeout: 30000
    };

    const req = https.request(requestOptions, (res) => {
      let data = '';
      
      res.on('data', (chunk) => {
        data += chunk;
      });
      
      res.on('end', () => {
        try {
          const jsonData = data ? JSON.parse(data) : {};
          resolve({
            status: res.statusCode,
            headers: res.headers,
            data: jsonData
          });
        } catch (error) {
          resolve({
            status: res.statusCode,
            headers: res.headers,
            data: data
          });
        }
      });
    });

    req.on('error', (error) => {
      reject(error);
    });

    req.on('timeout', () => {
      req.destroy();
      reject(new Error('Request timeout'));
    });

    if (options.body) {
      req.write(JSON.stringify(options.body));
    }

    req.end();
  });
}

async function testWordPressPublishing() {
  log('\nðŸš€ WordPress Publishing Test (Mock Content)', 'bold');
  log('=' .repeat(60), 'blue');
  
  const mockContent = {
    title: 'Test Post: The Future of AI in Business',
    content: `
      <h2>The Future of Artificial Intelligence in Business</h2>
      <p>Artificial Intelligence is transforming the business landscape at an unprecedented pace. From automating routine tasks to providing deep insights from data, AI is becoming an essential tool for modern enterprises.</p>
      
      <h3>Key Areas of Impact</h3>
      <ul>
        <li><strong>Automation:</strong> Streamlining repetitive processes</li>
        <li><strong>Analytics:</strong> Extracting insights from big data</li>
        <li><strong>Customer Service:</strong> Enhancing user experiences</li>
        <li><strong>Decision Making:</strong> Supporting strategic planning</li>
      </ul>
      
      <h3>Looking Ahead</h3>
      <p>As AI technology continues to evolve, businesses that embrace these tools will gain significant competitive advantages. The key is to start implementing AI solutions today to prepare for tomorrow's challenges.</p>
      
      <p><em>This is a test post generated by the Content Pipeline system.</em></p>
    `,
    excerpt: 'Explore how Artificial Intelligence is transforming business operations and what the future holds for AI-driven enterprises.'
  };

  log('\nðŸ“ Mock Content Created:', 'bold');
  log(`   Title: ${mockContent.title}`, 'blue');
  log(`   Content Length: ${mockContent.content.length} characters`, 'blue');
  log(`   Excerpt: ${mockContent.excerpt}`, 'blue');

  try {
    log('\nðŸ“¤ Publishing to WordPress...', 'cyan');
    
    const response = await makeRequest(`${CONFIG.supabase.url}/functions/v1/direct-content-generation`, {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${CONFIG.supabase.anonKey}`,
        'Content-Type': 'application/json'
      },
      body: {
        topic: 'The Future of Artificial Intelligence in Business',
        contentType: 'blog post',
        targetAudience: 'business professionals',
        tone: 'professional and informative',
        wordCount: 500,
        includeExamples: true,
        publishToWordPress: true,
        testMode: false,
        mockContent: mockContent // Pass mock content to bypass OpenAI
      }
    });

    log(`\nðŸ“Š Response Status: ${response.status}`, 'blue');

    if (response.status === 200) {
      log('   âœ… WordPress publishing completed successfully!', 'green');
      
      if (response.data.success) {
        log('\nðŸ“ Publishing Results:', 'bold');
        log(`   Title: ${response.data.content?.title || 'N/A'}`, 'blue');
        log(`   Content Length: ${response.data.content?.content?.length || 0} characters`, 'blue');
        
        if (response.data.wordpress) {
          log('\nðŸ“¤ WordPress Publishing:', 'bold');
          log(`   Published: ${response.data.wordpress.published ? 'Yes' : 'No'}`, 'blue');
          if (response.data.wordpress.postId) {
            log(`   Post ID: ${response.data.wordpress.postId}`, 'blue');
          }
          if (response.data.wordpress.postUrl) {
            log(`   Post URL: ${response.data.wordpress.postUrl}`, 'blue');
          }
        }
        
        log('\nðŸŽ‰ WordPress publishing is working perfectly!', 'green');
        log('âœ… Content Processing â†’ WordPress Publishing', 'green');
        
      } else {
        log('   âŒ WordPress publishing failed', 'red');
        log(`   Error: ${response.data.error || 'Unknown error'}`, 'red');
      }
      
    } else {
      log('   âŒ Function call failed', 'red');
      log(`   Status: ${response.status}`, 'red');
      log(`   Response: ${JSON.stringify(response.data, null, 2)}`, 'red');
    }

  } catch (error) {
    log(`\nâŒ Test failed: ${error.message}`, 'red');
  }

  log('\nðŸ“‹ Next Steps:', 'bold');
  log('   1. If successful: WordPress publishing is working!', 'green');
  log('   2. If failed: Check WordPress configuration', 'yellow');
  log('   3. Once OpenAI billing is active, test full content generation', 'blue');
  log('   4. Set up automated content scheduling', 'blue');
}

// Run the test
if (require.main === module) {
  testWordPressPublishing()
    .then(() => {
      process.exit(0);
    })
    .catch((error) => {
      log(`\nðŸ’¥ WordPress publishing test failed: ${error.message}`, 'red');
      process.exit(1);
    });
}

module.exports = { testWordPressPublishing, CONFIG };

